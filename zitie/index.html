<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能字帖生成器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #45a049;
            --secondary-color: #2196F3;
            --secondary-hover: #0b7dda;
            --print-color: #ff9800;
            --print-hover: #e68a00;
            --zoom-color: #607d8b;
            --zoom-hover: #455a64;
            --panel-bg: white;
            --panel-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border-color: #ddd;
            --text-color: #333;
            --light-text: #666;
            --error-color: #f44336;
            --success-color: #4CAF50;
            --info-color: #2196F3;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
            color: var(--text-color);
        }
        
        /* 基础布局 */
        .container {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            gap: 20px;
            padding: 20px;
            flex-direction: column;
        }
        
        .settings-panel {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--panel-shadow);
            margin-bottom: 20px;
        }
        
        .input-panel {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--panel-shadow);
            margin-bottom: 20px;
        }
        
        .preview-panel {
            background-color: var(--panel-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--panel-shadow);
        }

        /* 其他原有样式保持不变... */
        
        /* 响应式设计 */
        @media (min-width: 600px) {
            /* 平板布局 */
            .container {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .settings-panel {
                flex: 0 0 100%;
            }
            
            .input-panel {
                flex: 1;
                min-width: 300px;
            }
            
            .preview-panel {
                flex: 2;
                min-width: 400px;
            }
        }

        @media (min-width: 900px) {
            /* 桌面布局 */
            .container {
                flex-wrap: nowrap;
            }
            
            .settings-panel {
                flex: 1;
                min-width: 250px;
            }
            
            .input-panel {
                flex: 1;
                min-width: 300px;
            }
            
            .preview-panel {
                flex: 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 功能区面板 -->
        <div class="settings-panel">
            <h1>多功能字帖生成器</h1>
            
            <!-- 功能区 - 模仿Office -->
            <div class="ribbon">
                <div class="ribbon-group">
                    <span class="ribbon-group-title">模式</span>
                    <label><input type="radio" name="gridMode" value="rice" checked> 米字格</label>
                    <label><input type="radio" name="gridMode" value="square"> 方格</label>
                </div>
                
                <div class="ribbon-group">
                    <span class="ribbon-group-title">PDF</span>
                    <button id="generatePdf">生成PDF</button>
                    <button id="generateBlankPdf" class="blank-grid-btn">空白格纸</button>
                    <button id="printBtn" class="print-btn">打印</button>
                </div>
                
                <div class="ribbon-group">
                    <span class="ribbon-group-title">选项</span>
                    <div class="checkbox-label">
                        <input type="checkbox" id="showHeader" checked>
                        <label for="showHeader">标题区</label>
                    </div>
                    <div class="checkbox-label">
                        <input type="checkbox" id="enableWatermark" checked>
                        <label for="enableWatermark">水印</label>
                    </div>
                </div>
            </div>
            
            <!-- 模式特定设置 -->
            <div id="riceSettings">
                <div class="checkbox-label">
                    <input type="checkbox" id="alternateEmptyRow">
                    <label for="alternateEmptyRow">空行间隔</label>
                </div>
                <div class="input-group" id="emptyRowControl" style="display:none;">
                    <label for="emptyRowCount">空行数量:</label>
                    <input type="number" id="emptyRowCount" min="0" max="3" value="1">
                </div>
            </div>
            
            <div id="squareSettings" style="display:none;">
                <div class="checkbox-label">
                    <input type="checkbox" id="indentParagraph" checked>
                    <label for="indentParagraph">段落缩进</label>
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="showPunctuation" checked>
                    <label for="showPunctuation">显示标点</label>
                </div>
            </div>
            
            <div id="pdfStatus" class="status-message info">准备生成PDF</div>
        </div>
        
        <!-- 输入面板 -->
        <div class="input-panel">
            <h2>输入内容</h2>
            <textarea id="content" placeholder="请输入您想练习的文字..."></textarea>
        </div>
        
        <!-- 预览面板 -->
        <div class="preview-panel">
            <div class="preview-header">
                <h2>实时预览</h2>
                <div class="zoom-controls">
                    <button id="zoomOut" class="zoom-btn" title="缩小">-</button>
                    <span id="zoomValue" class="zoom-value">100%</span>
                    <button id="zoomIn" class="zoom-btn" title="放大">+</button>
                </div>
            </div>
            <div class="preview-content">
                <div id="previewContainer">
                    <div class="a4-page">
                        <p style="text-align:center;">请输入内容以预览字帖</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载界面 -->
    <div id="loadingContainer" class="loading-container">
        <div class="loading-content">
            <h3>正在预加载字库图片</h3>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            <p id="loadingStatus">准备开始加载...</p>
        </div>
    </div>

</body>
</html>

    <script>
        const { jsPDF } = window.jspdf;

        // 存储数据
        let characterImages = {};
        let ricePatternImage = '字库/box.png';
        let currentContent = "";
        let currentMode = "rice";
        let currentZoom = 1.0;
        const imageCache = {};

        // 获取页面元素
        const contentTextarea = document.getElementById('content');
        const generatePdfButton = document.getElementById('generatePdf');
        const generateBlankPdfButton = document.getElementById('generateBlankPdf');
        const printBtn = document.getElementById('printBtn');
        const previewContainer = document.getElementById('previewContainer');
        const previewContent = document.querySelector('.preview-content');
        const pdfStatus = document.getElementById('pdfStatus');
        const enableWatermarkCheckbox = document.getElementById('enableWatermark');
        const showHeaderCheckbox = document.getElementById('showHeader');
        const alternateEmptyRowCheckbox = document.getElementById('alternateEmptyRow');
        const emptyRowCountInput = document.getElementById('emptyRowCount');
        const emptyRowControlDiv = document.getElementById('emptyRowControl');
        const indentParagraphCheckbox = document.getElementById('indentParagraph');
        const showPunctuationCheckbox = document.getElementById('showPunctuation');
        const riceSettingsDiv = document.getElementById('riceSettings');
        const squareSettingsDiv = document.getElementById('squareSettings');
        const modeRadios = document.querySelectorAll('input[name="gridMode"]');
        const zoomOutBtn = document.getElementById('zoomOut');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomValue = document.getElementById('zoomValue');
        const loadingContainer = document.getElementById('loadingContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const loadingStatus = document.getElementById('loadingStatus');

        // 设置事件监听
        contentTextarea.addEventListener('input', updatePreview);
        generatePdfButton.addEventListener('click', generatePdf);
        generateBlankPdfButton.addEventListener('click', generateBlankPdf);
        printBtn.addEventListener('click', printSheets);
        enableWatermarkCheckbox.addEventListener('change', updatePreview);
        showHeaderCheckbox.addEventListener('change', updatePreview);
        
        alternateEmptyRowCheckbox.addEventListener('change', function() {
            emptyRowControlDiv.style.display = this.checked ? 'block' : 'none';
            updatePreview();
        });
        
        emptyRowCountInput.addEventListener('change', updatePreview);
        indentParagraphCheckbox.addEventListener('change', updatePreview);
        showPunctuationCheckbox.addEventListener('change', updatePreview);
        zoomOutBtn.addEventListener('click', () => adjustZoom(-0.1));
        zoomInBtn.addEventListener('click', () => adjustZoom(0.1));

        // 模式选择切换
        modeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                currentMode = this.value;
                if (currentMode === "rice") {
                    riceSettingsDiv.style.display = "block";
                    squareSettingsDiv.style.display = "none";
                } else {
                    riceSettingsDiv.style.display = "none";
                    squareSettingsDiv.style.display = "block";
                }
                updatePreview();
            });
        });

        // 预加载所有字符图片
        async function preloadCharacterImages() {
    loadingContainer.style.display = 'flex';
    loadingStatus.textContent = '正在加载字库...';
    
    try {
        // 1. 加载字符JSON数据
        const response = await fetch('characters.json');
        if (!response.ok) throw new Error('字符列表加载失败');
        
        const charMap = await response.json();
        const existingChars = Object.keys(charMap);
        const punctuations = ['，', '。', '、', '；', '：', '？', '！', '「', '」', '『', '』', '《', '》', '（', '）', '—', '…', '·', '“', '”', '‘', '’'];
        const allChars = [...existingChars, ...punctuations];
        
        // 2. 更新进度显示
        loadingStatus.textContent = `共 ${allChars.length} 个字符需要加载`;
        
        // 3. 分批加载（每批50个字符）
        const batchSize = 50;
        for (let i = 0; i < allChars.length; i += batchSize) {
            const batch = allChars.slice(i, i + batchSize);
            const results = await Promise.all(
                batch.map(char => loadCharacterImage(char, charMap))
            );
            
            // 更新进度
            const loadedCount = Math.min(i + batchSize, allChars.length);
            const progress = Math.round((loadedCount / allChars.length) * 100);
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            loadingStatus.textContent = `已加载 ${loadedCount}/${allChars.length}`;
            
            await new Promise(resolve => setTimeout(resolve, 20));
        }
        
        // 4. 完成处理
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        loadingStatus.textContent = `预加载完成，共加载 ${allChars.length} 个字符`;
        
        setTimeout(() => {
            loadingContainer.style.display = 'none';
            pdfStatus.textContent = '字帖生成器已就绪';
            pdfStatus.className = 'status-message success';
        }, 800);
        
    } catch (error) {
        console.error('预加载失败:', error);
        loadingStatus.textContent = `加载失败: ${error.message}`;
        progressBar.style.backgroundColor = '#ff6b6b';
        
        setTimeout(() => {
            loadingContainer.style.display = 'none';
            pdfStatus.textContent = '字库加载失败，部分功能可能受限';
            pdfStatus.className = 'status-message error';
        }, 3000);
    }
}

        // 加载字符图片
        async function loadCharacterImage(char, charMap) {
    if (imageCache[char]) return true;
    if (!char || char === ' ') return false;
    
    const imgPath = charMap[char] || `字库/${char}.png`;
    const img = new Image();
    
    return await new Promise((resolve) => {
        img.onload = () => {
            imageCache[char] = imgPath;
            characterImages[char] = imgPath;
            resolve(true);
        };
        img.onerror = () => resolve(false);
        img.src = imgPath;
    });
}

        // 调整缩放比例
        function adjustZoom(change) {
            currentZoom = Math.max(0.3, Math.min(2.0, currentZoom + change));
            applyZoom();
        }

        // 应用缩放
        function applyZoom() {
            const pages = document.querySelectorAll('.a4-page');
            pages.forEach(page => {
                page.style.transform = `scale(${currentZoom})`;
            });
            zoomValue.textContent = `${Math.round(currentZoom * 100)}%`;
            
            // 调整预览区域的滚动位置以保持居中
            if (pages.length > 0) {
                const firstPage = pages[0];
                const containerRect = previewContent.getBoundingClientRect();
                const pageRect = firstPage.getBoundingClientRect();
                
                previewContent.scrollLeft = (pageRect.width * currentZoom - containerRect.width) / 2;
            }
        }

        // 打印功能
        function printSheets() {
            if (!currentContent.trim() && !confirm('当前没有内容，确定要打印空白页吗？')) {
                return;
            }
            window.print();
        }

        function preprocessText(text) {
            const punctuations = ['，', '。', '、', '；', '：', '？', '！', '「', '」', '『', '』', '《', '》', '（', '）', '—', '…', '·', '“', '”', '‘', '’'];
            return text.split('').filter(char => !punctuations.includes(char)).join('').replace(/[^\S\n]/g, '');
        }

        // 创建A4页面
        function createA4Page() {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'a4-page';

            // 始终创建头部容器（保留空间）
            const headerDiv = document.createElement('div');
            headerDiv.className = currentMode === "rice" ? 'rice-header-section' : 'square-header-section';
            
            // 根据复选框状态决定是否显示内容
            if (showHeaderCheckbox.checked) {
                const schoolSpan = document.createElement('span');
                schoolSpan.textContent = '学校：__________';
                
                const classSpan = document.createElement('span');
                classSpan.textContent = '班级：__________';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = '姓名：__________';
                
                headerDiv.appendChild(schoolSpan);
                headerDiv.appendChild(classSpan);
                headerDiv.appendChild(nameSpan);
            } else {
                // 不显示内容时添加空span保持高度
                const emptySpan = document.createElement('span');
                emptySpan.innerHTML = '&nbsp;';
                headerDiv.appendChild(emptySpan);
            }
            
            pageDiv.appendChild(headerDiv);
            const pageNumberDiv = document.createElement('div');
            pageNumberDiv.className = 'page-number';
            pageDiv.appendChild(pageNumberDiv);
            
            return pageDiv;
        }

        // 创建米字格网格
        function createRiceGrid() {
            const gridContainer = document.createElement('div');
            gridContainer.className = 'rice-grid-container';
            return gridContainer;
        }

        // 创建方格网格
        function createSquareGrid() {
            const gridContainer = document.createElement('div');
            gridContainer.className = 'square-grid-container';
            return gridContainer;
        }

        // 创建米字格单元格
        function createRiceCell(char, position) {
    const cell = document.createElement('div');
    cell.className = 'rice-grid-cell';
    
    if (ricePatternImage) {
        const ricePattern = document.createElement('img');
        ricePattern.className = 'rice-pattern';
        ricePattern.src = ricePatternImage;
        cell.appendChild(ricePattern);
    }
    
    if (![0, 1, 6].includes(position)) return cell;
    if (!char || char === ' ') return cell;

    if (characterImages[char]) {
        const img = document.createElement('img');
        img.className = 'character-img';
        img.src = characterImages[char];
        img.alt = char;
        
        if (position === 1 || position === 6) {
            img.style.opacity = '0.5';
        }
        
        cell.appendChild(img);
    } else {
        const charSpan = document.createElement('span');
        charSpan.textContent = char;
        charSpan.style.position = 'absolute';
        charSpan.style.top = '50%';
        charSpan.style.left = '50%';
        charSpan.style.transform = 'translate(-50%, -50%)';
        charSpan.style.fontFamily = '"KaiTi", "楷体", serif';
        charSpan.style.fontSize = '1.0cm';
        charSpan.style.zIndex = '2';
        
        if (position === 1 || position === 6) {
            charSpan.style.opacity = '0.5';
        }
        
        cell.appendChild(charSpan);
    }
    
    return cell;
}

        // 创建方格单元格
        async function createSquareCell(char) {
            const cell = document.createElement('div');
            cell.className = 'square-grid-cell';
            
            if (!char || char === ' ') return cell;

            // 尝试加载图片
            const hasImage = await loadCharacterImage(char);
            
            if (hasImage && characterImages[char]) {
                const img = document.createElement('img');
                img.src = characterImages[char];
                img.alt = char;
                cell.appendChild(img);
            } else {
                cell.textContent = char;
                cell.style.fontFamily = '"KaiTi", "楷体", serif';
                cell.style.fontSize = '0.7cm';
            }
            return cell;
        }

        // 判断是否是标点符号
        function isPunctuation(char) {
            const punctuations = ['，', '。', '、', '；', '：', '？', '！', '」', '』', '》', '）', '…', '—', '”', '’', 
                                '「', '『', '《', '（', '—', '…', '·', '"', "'", ':', ';', ',', '.', '?', '!'];
            return punctuations.includes(char);
        }

        // 更新预览
        async function updatePreview() {
            currentContent = contentTextarea.value;
            previewContainer.innerHTML = '';
            
            if (!currentContent.trim()) {
                const emptyPage = document.createElement('div');
                emptyPage.className = 'a4-page';
                emptyPage.innerHTML = '<p style="text-align:center;">请输入内容以预览字帖</p>';
                previewContainer.appendChild(emptyPage);
                applyZoom();
                return;
            }

            if (currentMode === "rice") {
                await updateRicePreview();
            } else {
                await updateSquarePreview();
            }
            
            applyZoom();
        }

        // 更新米字格预览
        async function updateRicePreview() {
            const chars = Array.from(preprocessText(currentContent));
            let charIndex = 0;
            let pageCount = 0;
            
            const emptyRowCount = alternateEmptyRowCheckbox.checked ? parseInt(emptyRowCountInput.value) : 0;
            
            // 计算每页可以放置的字符数（空两行时每页5个单字）
            const charsPerPage = emptyRowCount === 2 ? 5 : Math.floor(16 / (emptyRowCount + 1)) * 3;
            
            while (charIndex < chars.length || (chars.length === 0 && pageCount === 0)) {
                // 创建新页面
                const pageDiv = createA4Page();
                const gridContainer = createRiceGrid();
                pageDiv.appendChild(gridContainer);
                
                // 设置页码
                const pageNumberDiv = pageDiv.querySelector('.page-number');
                pageNumberDiv.textContent = `第 ${pageCount + 1} 页`;
                
                previewContainer.appendChild(pageDiv);
                pageCount++;
                
                let row = 0;
                let charsPlacedOnPage = 0;
                
                // 每页固定16行
                while (row < 16) {
                    // 放置字符行
                    for (let col = 0; col < 11; col++) {
                        if ((col === 0 || col === 1 || col === 6) && 
                            charIndex < chars.length && 
                            charsPlacedOnPage < charsPerPage) {
                            
                            const cell = await createRiceCell(chars[charIndex], col);
                            gridContainer.appendChild(cell);
                            
                            // 只在第6列(第三个格子)增加字符索引
                            if (col === 6) {
                                charIndex++;
                                charsPlacedOnPage++;
                            }
                        } else {
                            // 填充空白格子
                            const cell = await createRiceCell(null, -1);
                            gridContainer.appendChild(cell);
                        }
                    }
                    row++;
                    
                    // 添加空行（如果启用）
                    if (alternateEmptyRowCheckbox.checked && row < 16) {
                        const currentEmptyRows = emptyRowCount;
                        
                        for (let i = 0; i < currentEmptyRows && row < 16; i++) {
                            for (let col = 0; col < 11; col++) {
                                const cell = await createRiceCell(null, -1);
                                gridContainer.appendChild(cell);
                            }
                            row++;
                        }
                    }
                }
                
                // 添加水印到预览
                if (enableWatermarkCheckbox.checked) {
                    const watermark = document.createElement('div');
                    watermark.className = 'watermark';
                    watermark.textContent = '巧思蓓晚托班';
                    pageDiv.appendChild(watermark);
                }
            }
            
            // 添加页数提示
            const pageInfo = document.createElement('div');
            pageInfo.style.marginTop = '10px';
            pageInfo.style.fontSize = '14px';
            pageInfo.style.color = '#666';
            pageInfo.textContent = `共 ${pageCount} 页`;
            previewContainer.appendChild(pageInfo);
        }

        // 更新方格预览
        async function updateSquarePreview() {
            // 标点符号规则定义
            const PUNCTUATION_RULES = {
                notStart: ['，', '。', '、', '；', '：', '？', '！', '」', '』', '》', '）', '…', '—', '”', '’'],
                doubleWidth: ['——', '……'],
                allPunctuation: ['，', '。', '、', '；', '：', '？', '！', '」', '』', '》', '）', '…', '—', '”', '’', 
                                '「', '『', '《', '（', '—', '…', '·', '“', '”', '‘', '’']
            };

            // 标点位置样式定义
            const PUNCTUATION_STYLES = {
                '，': { right: '-0.2cm', bottom: '0.1cm', size: '0.5cm' },
                '。': { right: '-0.2cm', bottom: '0.1cm', size: '0.5cm' },
                '、': { right: '-0.2cm', bottom: '0.1cm', size: '0.5cm' },
                '；': { right: '-0.2cm', top: '50%', size: '0.5cm' },
                '：': { right: '-0.2cm', top: '50%', size: '0.5cm' },
                '？': { right: '-0.2cm', top: '50%', size: '0.5cm' },
                '！': { right: '-0.2cm', top: '50%', size: '0.5cm' },
                '》': { right: '-0.2cm', top: '50%', size: '0.5cm' },
                '「': { right: '-0.2cm', top: '0.1cm', size: '0.5cm' },
                '」': { right: '-0.2cm', top: '0.1cm', size: '0.5cm' },
                '『': { right: '-0.2cm', top: '0.1cm', size: '0.5cm' },
                '』': { right: '-0.2cm', top: '0.1cm', size: '0.5cm' },
                '“': { right: '-0.2cm', bottom: '0.5cm', size: '0.5cm' },
                '”': { right: '-0.2cm', bottom: '0.5cm', size: '0.5cm' },
                '‘': { right: '-0.2cm', top: '-0.2cm', size: '0.5cm' },
                '’': { right: '-0.2cm', top: '-0.2cm', size: '0.5cm' }
            };

            // 处理原始文本
            function processOriginalText(text) {
                // 保留换行符，只移除其他空白字符
                let processedText = text.replace(/[^\S\n]/g, '');
                
                // 如果不显示标点，过滤掉所有标点符号
                if (!showPunctuationCheckbox.checked) {
                    const punctuationRegex = new RegExp(`[${PUNCTUATION_RULES.allPunctuation.join('')}]`, 'g');
                    processedText = processedText.replace(punctuationRegex, '');
                }
                
                return processedText;
            }

            // 分割文本为字符数组（处理双宽度标点）
            function splitTextToChars(text) {
                const chars = [];
                for (let i = 0; i < text.length; i++) {
                    const currentChar = text[i];
                    const nextChar = text[i + 1] || '';
                    
                    if (PUNCTUATION_RULES.doubleWidth.includes(currentChar + nextChar)) {
                        chars.push(currentChar + nextChar);
                        i++;
                    } else {
                        chars.push(currentChar);
                    }
                }
                return chars;
            }

            // 将字符数组组织为行
            function organizeCharsToLines(chars) {
                let allLines = [];
                let currentLine = [];
                let isNewParagraph = true;

                for (let i = 0; i < chars.length; i++) {
                    const char = chars[i];
                    
                    // 处理换行符 - 作为段落分隔
                    if (char === '\n') {
                        // 保存当前行（如果有内容）
                        if (currentLine.length > 0) {
                            allLines.push({
                                content: currentLine,
                                isNewParagraph: isNewParagraph
                            });
                            currentLine = [];
                        }
                        // 添加一个空行表示段落分隔
                        allLines.push({
                            content: [],
                            isNewParagraph: true
                        });
                        isNewParagraph = true;
                        continue;
                    }

                    // 检查是否会导致标点出现在行首
                    if (currentLine.length === 0 && PUNCTUATION_RULES.notStart.includes(char)) {
                        // 尝试将标点附加到上一行最后一个格子
                        if (allLines.length > 0) {
                            const lastLine = allLines[allLines.length - 1];
                            if (lastLine.content.length > 0) {
                                // 将最后一个格子改为"文字+标点"组合
                                const lastChar = lastLine.content[lastLine.content.length - 1];
                                lastLine.content[lastLine.content.length - 1] = lastChar + char;
                                continue;
                            }
                        }
                        // 如果是第一行第一个字符是标点，无法调整，保留
                    }

                    // 如果是新段落且需要缩进，添加两个空格
                    if (isNewParagraph && indentParagraphCheckbox.checked && currentLine.length === 0) {
                        currentLine.push(' '); // 第一个空格
                        currentLine.push(' '); // 第二个空格
                        isNewParagraph = false; // 已经处理过缩进
                    }

                    currentLine.push(char);
                    
                    // 行满处理
                    if (currentLine.length === 12) {
                        allLines.push({
                            content: currentLine,
                            isNewParagraph: isNewParagraph
                        });
                        currentLine = [];
                        isNewParagraph = false; // 不是新段落
                    }
                }

                // 添加最后一行
                if (currentLine.length > 0) {
                    while (currentLine.length < 12) {
                        currentLine.push(' '); // 用空格填充不足部分
                    }
                    allLines.push({
                        content: currentLine,
                        isNewParagraph: isNewParagraph
                    });
                }

                return allLines;
            }

            // 创建主文字元素
            function createMainCharacterElement(char) {
    const container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.width = '100%';
    container.style.height = '100%';
    container.style.left = '0';
    container.style.top = '0';
    
    const charSpan = document.createElement('div');
    charSpan.style.position = 'absolute';
    charSpan.style.left = '50%';
    charSpan.style.top = '50%';
    charSpan.style.transform = 'translate(-50%, -50%)';
    
    if (characterImages[char]) {
        const img = document.createElement('img');
        img.src = characterImages[char];
        img.alt = char;
        img.style.width = '1.1cm';
        img.style.height = '1.1cm';
        img.style.position = 'relative';
        img.style.top = '0.05cm';
        charSpan.appendChild(img);
    } else {
        charSpan.textContent = char;
        charSpan.style.fontFamily = '"KaiTi", "楷体", serif';
        charSpan.style.fontSize = '0.7cm';
    }
    
    container.appendChild(charSpan);
    return container;
}

            // 创建标点元素
            function createPunctuationElement(punct) {
    const position = PUNCTUATION_STYLES[punct];
    const punctSpan = document.createElement('div');
    punctSpan.style.position = 'absolute';
    punctSpan.style.right = position.right;
    punctSpan.style.bottom = position.bottom;
    
    if (characterImages[punct]) {
        const img = document.createElement('img');
        img.src = characterImages[punct];
        img.alt = punct;
        img.style.width = position.size;
        img.style.height = position.size;
        punctSpan.appendChild(img);
    } else {
        punctSpan.textContent = punct;
        punctSpan.style.fontFamily = '"KaiTi", "楷体", serif';
        punctSpan.style.fontSize = position.size;
    }
    
    return punctSpan;
}
            // 创建双宽度字符单元格
            async function createDoubleWidthCell(content) {
                const isDash = content === '——';
                const leftChar = isDash ? '—' : '…';
                const rightChar = isDash ? '—' : '…';
                
                // 创建左半部分格子
                const leftCell = document.createElement('div');
                leftCell.className = 'square-grid-cell';
                
                // 创建右半部分格子
                const rightCell = document.createElement('div');
                rightCell.className = 'square-grid-cell';
                
                // 创建左半部分内容
                const leftContent = document.createElement('div');
                leftContent.style.position = 'absolute';
                leftContent.style.width = '100%';
                leftContent.style.height = '100%';
                leftContent.style.left = '0';
                leftContent.style.top = '0';
                
                const leftCharSpan = document.createElement('div');
                leftCharSpan.style.position = 'absolute';
                leftCharSpan.style.right = '0';
                leftCharSpan.style.top = '50%';
                leftCharSpan.style.transform = 'translateY(-50%)';
                
                const hasLeftImage = await loadCharacterImage(leftChar);
                
                if (hasLeftImage && characterImages[leftChar]) {
                    const img = document.createElement('img');
                    img.src = characterImages[leftChar];
                    img.alt = leftChar;
                    img.style.width = '0.9cm';
                    img.style.height = '1.0cm';
                    leftCharSpan.appendChild(img);
                } else {
                    leftCharSpan.textContent = leftChar;
                    leftCharSpan.style.fontFamily = '"KaiTi", "楷体", serif';
                    leftCharSpan.style.fontSize = '0.9cm';
                }
                
                leftContent.appendChild(leftCharSpan);
                leftCell.appendChild(leftContent);
                
                // 创建右半部分内容
                const rightContent = document.createElement('div');
                rightContent.style.position = 'absolute';
                rightContent.style.width = '100%';
                rightContent.style.height = '100%';
                rightContent.style.left = '0';
                rightContent.style.top = '0';
                
                const rightCharSpan = document.createElement('div');
                rightCharSpan.style.position = 'absolute';
                rightCharSpan.style.left = '0';
                rightCharSpan.style.top = '50%';
                rightCharSpan.style.transform = 'translateY(-50%)';
                
                const hasRightImage = await loadCharacterImage(rightChar);
                
                if (hasRightImage && characterImages[rightChar]) {
                    const img = document.createElement('img');
                    img.src = characterImages[rightChar];
                    img.alt = rightChar;
                    img.style.width = '0.9cm';
                    img.style.height = '1.0cm';
                    rightCharSpan.appendChild(img);
                } else {
                    rightCharSpan.textContent = rightChar;
                    rightCharSpan.style.fontFamily = '"KaiTi", "楷体", serif';
                    rightCharSpan.style.fontSize = '0.9cm';
                }
                
                rightContent.appendChild(rightCharSpan);
                rightCell.appendChild(rightContent);
                
                // 标记这两个单元格为特殊字符的一部分
                leftCell.dataset.doubleChar = 'left';
                rightCell.dataset.doubleChar = 'right';
                
                return [leftCell, rightCell];
            }

            // 创建带标点的格子
            async function createSquareCellWithPunctuation(content) {
                const cell = document.createElement('div');
                cell.className = 'square-grid-cell';
                
                // 如果不显示标点且内容是标点，返回空单元格
                if (!showPunctuationCheckbox.checked && content && PUNCTUATION_RULES.allPunctuation.includes(content)) {
                    return cell;
                }
                
                // 处理双宽度字符
                if (content === '——' || content === '……') {
                    return await createDoubleWidthCell(content);
                }

                // 处理组合字符（文字+标点）
                if (content && content.length > 1 && PUNCTUATION_STYLES[content.slice(-1)]) {
                    const mainChar = content.slice(0, -1);
                    const punctuation = content.slice(-1);
                    
                    cell.appendChild(await createMainCharacterElement(mainChar));
                    cell.appendChild(await createPunctuationElement(punctuation));
                    return cell;
                }

                // 普通字符处理
                if (content) {
                    cell.appendChild(await createMainCharacterElement(content));
                }
                return cell;
            }

            // 生成预览页面
            async function generatePreviewPages(allLines) {
                previewContainer.innerHTML = '';
                let pageCount = 0;
                let lineIndex = 0;
                
                while (pageCount === 0 || lineIndex < allLines.length) {
                    const pageDiv = createA4Page();
                    const gridContainer = createSquareGrid();
                    pageDiv.appendChild(gridContainer);
                    previewContainer.appendChild(pageDiv);
                    pageCount++;

                    // 填充当前页 (20行)
                    for (let row = 1; row <= 20; row++) {
                        // 如果已经没有更多行，填充空行
                        if (lineIndex >= allLines.length) {
                            for (let i = 0; i < 12; i++) {
                                gridContainer.appendChild(await createSquareCellWithPunctuation(null));
                            }
                            continue;
                        }

                        const currentLine = allLines[lineIndex];
                        
                        if (row % 2 === 0) {
                            // 空行（描红行）
                            for (let i = 0; i < 12; i++) {
                                gridContainer.appendChild(await createSquareCellWithPunctuation(null));
                            }
                        } else {
                            // 处理行中的字符
                            let colIndex = 0;
                            let i = 0;
                            
                            // 如果是空行（段落分隔），直接跳过
                            if (currentLine.content.length === 0) {
                                lineIndex++;
                                row--; // 补偿这一行，因为我们要跳过它
                                continue;
                            }
                            
                            while (i < currentLine.content.length && colIndex < 12) {
                                const char = currentLine.content[i];
                                const cells = await createSquareCellWithPunctuation(char);
                                
                                if (Array.isArray(cells)) {
                                    gridContainer.appendChild(cells[0]);
                                    gridContainer.appendChild(cells[1]);
                                    colIndex += 2;
                                } else {
                                    gridContainer.appendChild(cells);
                                    colIndex += 1;
                                }
                                i++;
                            }

                            // 填充剩余空白格子
                            while (colIndex < 12) {
                                gridContainer.appendChild(await createSquareCellWithPunctuation(null));
                                colIndex++;
                            }

                            lineIndex++;
                        }
                    }

                    // 添加水印
                    if (enableWatermarkCheckbox.checked) {
                        const watermark = document.createElement('div');
                        watermark.className = 'watermark';
                        watermark.textContent = '巧思蓓晚托班';
                        pageDiv.appendChild(watermark);
                    }
                }

                return pageCount;
            }

            // 主流程
            let originalText = processOriginalText(currentContent);
            
            if (!originalText.trim()) {
                previewContainer.innerHTML = '<div class="a4-page"><p style="text-align:center;">请输入内容以预览字帖</p></div>';
                applyZoom();
                return;
            }

            const chars = splitTextToChars(originalText);
            const allLines = organizeCharsToLines(chars);
            const pageCount = await generatePreviewPages(allLines);

            // 添加页数信息
            const pageInfo = document.createElement('div');
            pageInfo.textContent = `共 ${pageCount} 页`;
            pageInfo.className = 'page-info';
            previewContainer.appendChild(pageInfo);

            applyZoom();
        }

        // 生成PDF
        async function generatePdf() {
            if (!currentContent.trim()) {
                pdfStatus.textContent = '请输入内容以生成字帖';
                pdfStatus.className = 'status-message error';
                return;
            }
            
            if (currentMode === "rice" && !ricePatternImage) {
                pdfStatus.textContent = '没有找到米字格图片(box.png)';
                pdfStatus.className = 'status-message error';
                return;
            }
            
            if (Object.keys(characterImages).length === 0) {
                pdfStatus.textContent = '没有加载到单字图片';
                pdfStatus.className = 'status-message error';
                return;
            }
            
            pdfStatus.textContent = '正在生成PDF，请稍候...';
            pdfStatus.className = 'status-message info';
            
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'cm',
                format: 'a4'
            });
            
            const previewPages = document.querySelectorAll('.a4-page');
            let pageCount = 0;
            
            for (const page of previewPages) {
                try {
                    if (pageCount > 0) pdf.addPage();
                    
                    const canvas = await html2canvas(page, {
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        width: 21 * 37.8, // 将cm转换为px
                        height: 29.7 * 37.8,
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', 0, 0, 21, 29.7, undefined, 'FAST');
                    
                    // 添加页码（灰色、居中、距底部1cm）
                    pdf.setFontSize(10);
                    pdf.setTextColor(100); // 灰色
                    pdf.text(
                        `第 ${pageCount + 1} 页`, 
                        21 / 2, // 水平居中 (A4宽度21cm的一半)
                        29.7 - 1, // 距离底部1cm
                        { align: 'center' }
                    );

                    pageCount++;
                } catch (error) {
                    console.error('生成PDF时出错:', error);
                    pdfStatus.textContent = '生成PDF时出错';
                    pdfStatus.className = 'status-message error';
                    return;
                }
            }
            
            pdf.save(currentMode === "rice" ? '米字格字帖.pdf' : '方格字帖.pdf');
            pdfStatus.textContent = `PDF生成完成，共 ${pageCount} 页`;
            pdfStatus.className = 'status-message success';
        }

        // 生成空白格纸PDF
        async function generateBlankPdf() {
            if (currentMode === "rice" && !ricePatternImage) {
                pdfStatus.textContent = '没有找到米字格图片(box.png)';
                pdfStatus.className = 'status-message error';
                return;
            }
            
            pdfStatus.textContent = '正在生成空白格纸PDF，请稍候...';
            pdfStatus.className = 'status-message info';
            
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'cm',
                format: 'a4'
            });
            
            // 创建临时预览用于生成PDF
            const tempPreview = document.createElement('div');
            tempPreview.style.position = 'absolute';
            tempPreview.style.left = '-9999px';
            document.body.appendChild(tempPreview);
            
            const pageDiv = createA4Page();
            
            if (currentMode === "rice") {
                const gridContainer = createRiceGrid();
                pageDiv.appendChild(gridContainer);
                
                // 填充空白米字格 (16行 × 11列)
                for (let row = 0; row < 16; row++) {
                    for (let col = 0; col < 11; col++) {
                        const cell = await createRiceCell(null, -1);
                        gridContainer.appendChild(cell);
                    }
                    
                    // 如果启用空行间隔，添加空行
                    if (alternateEmptyRowCheckbox.checked && row < 15) {
                        row++;
                        for (let col = 0; col < 11; col++) {
                            const cell = await createRiceCell(null, -1);
                            gridContainer.appendChild(cell);
                        }
                    }
                }
            } else {
                const gridContainer = createSquareGrid();
                pageDiv.appendChild(gridContainer);
                
                // 填充空白方格 (20行 × 12列)
                for (let i = 0; i < 240; i++) {
                    gridContainer.appendChild(await createSquareCell(null));
                }
            }
            
            tempPreview.appendChild(pageDiv);
            
            // 添加水印
            if (enableWatermarkCheckbox.checked) {
                const watermark = document.createElement('div');
                watermark.className = 'watermark';
                watermark.textContent = '余老师制作';
                pageDiv.appendChild(watermark);
            }
            
            try {
                const canvas = await html2canvas(pageDiv, {
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    width: 21 * 37.8,
                    height: 29.7 * 37.8,
                    backgroundColor: '#FFFFFF' 
                    
                });
                
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, 21, 29.7, undefined, 'FAST');
                
                pdf.save(currentMode === "rice" ? '空白米字格.pdf' : '空白方格纸.pdf');
                pdfStatus.textContent = '空白格纸PDF生成完成';
                pdfStatus.className = 'status-message success';
            } catch (error) {
                console.error('生成PDF时出错:', error);
                pdfStatus.textContent = '生成PDF时出错';
                pdfStatus.className = 'status-message error';
            } finally {
                document.body.removeChild(tempPreview);
            }
        }

        // 初始化应用
        preloadCharacterImages();
        updatePreview();
    </script>
</body>
</html>
