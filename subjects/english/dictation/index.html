<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>分组文字转语音</title>
    <style>
    :root {
        --primary-color: #1A73E8;
        --secondary-color: #5F6368;
        --light-gray: #F1F3F4;
        --medium-gray: #DADCE0;
        --dark-gray: #5F6368;
        --success-color: #34A853;
    }
    
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: #FAFAFA;
        color: #202124;
        line-height: 1.5;
        padding: 0;
        margin: 0;
        -webkit-text-size-adjust: 100%;
    }
    
    .container {
        width: 100%;
        padding: 8px;
    }
    
    .panel {
        background-color: white;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        width: 100%;
        overflow: hidden;
    }
    
    h2 {
        color: #202124;
        margin-bottom: 12px;
        font-size: 1.2rem;
        font-weight: 500;
    }
    
    textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        border: 1px solid var(--medium-gray);
        border-radius: 6px;
        resize: vertical;
        font-size: 14px;
        margin-bottom: 10px;
        font-family: inherit;
    }
    
    .button-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
        width: 100%;
    }
    
    .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        width: 100%;
    }
    
    button {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 60px;
        flex: 1;
        text-align: center;
        white-space: nowrap;
        background-color: var(--light-gray);
        color: var(--dark-gray);
    }
    
    .small-btn {
        padding: 6px 10px;
        font-size: 12px;
    }
    
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }
    
    .btn-success {
        background-color: var(--success-color);
        color: white;
    }
    
    .btn-secondary {
        background-color: var(--secondary-color);
        color: white;
    }
    
    .hidden {
        display: none;
    }
    
    .content-list {
        margin-top: 12px;
        width: 100%;
        overflow-x: auto;
    }
    

    .content-grid.word-phrase-mode {
    grid-template-columns: repeat(2, 1fr);
}

/* 句子模式 - 每行 1 个 */
.content-grid.sentence-mode {
    grid-template-columns: 1fr;
}


    
    .content-item {
        display: flex;
        flex-direction: column;
        padding: 8px;
        border: 1px solid var(--medium-gray);
        border-radius: 6px;
        background-color: white;
        user-select: none;
        position: relative;
        min-height: 60px;
        word-break: break-word;
        height: 100%;
    }
    
    .content-item.selected {
        background-color: #E8F0FE;
        border-color: var(--primary-color);
    }
    
    /* 英语容器 */
    .english-container {
        font-weight: 500;
        color: #202124;
        white-space: pre-line;
        padding: 4px 6px 2px 6px;
        margin-bottom: 0;
        display: block;
        border-radius: 4px;
        font-size: 12px;
        line-height: 1.3;
    }

    /* 中文容器 */
    .chinese-container {
        color: var(--secondary-color);
        white-space: pre-line;
        padding: 2px 6px 4px 6px;
        margin-top: 0;
        display: block;
        border-radius: 4px;
        font-size: 11px;
        line-height: 1.3;
    }
    
    .dictation-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }
    
    .dictation-btn {
        width: 100%;
        padding: 12px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 6px;
        margin-top: 10px;
        height: 48px; 
    }
    
    .next-btn {
        background-color: var(--primary-color);
        color: white;
        font-size: 15px;
        padding: 16px;
        font-weight: 500;
    }
    
    .prev-btn {
        background-color: var(--light-gray);
        color: var(--dark-gray);
    }
    
    .progress {
        margin: 12px 0;
        font-size: 13px;
        color: var(--dark-gray);
        text-align: center;
    }
    
    .language-modes {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 12px;
        justify-content: center;
    }
    
    .language-btn {
        padding: 6px 10px;
        border-radius: 16px;
        background-color: var(--light-gray);
        color: var(--dark-gray);
        font-size: 12px;
        min-width: 70px;
    }
    
    .language-btn.active {
        background-color: var(--primary-color);
        color: white;
    }
    
    .language-modes-row2 {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
        justify-content: center;
    }
    
    .status-info {
        font-size: 13px;
        color: var(--dark-gray);
        margin: 8px 0;
        text-align: center;
    }
    
    .dictation-content {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        background-color: white;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    /* 听写英语文本 */
    .dictation-english {
        font-size: 1.2rem;
        font-weight: 500;
        margin-bottom: 10px;
        text-align: center;
        word-break: break-word;
        white-space: pre-line;
    }

    /* 听写中文文本 */
    .dictation-chinese {
        font-size: 1rem;
        color: var(--secondary-color);
        text-align: center;
        word-break: break-word;
        white-space: pre-line;
    }
    
    .dictation-chinese.hidden {
        display: none;
    }

    /* 新增分区样式 */
.content-section {
    margin-bottom: 20px;
}

.section-title {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--primary-color);
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--medium-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-count {
    font-size: 0.75rem;
    color: var(--secondary-color);
    font-weight: normal;
}

/* 调整原有样式 */
.content-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    width: 100%;
}

.word-item {
    flex: 1;
    min-width: calc(50% - 8px); /* 最小宽度 = 50% - 8px */
    max-width: calc(50% - 4px); /* 最大宽度 50% - 4px */
}

/* 词组卡片 - 最小宽度 50% - 8px，最大 50% */
.phrase-item {
    flex: 1;
    min-width: calc(50% - 8px);
    max-width: calc(50% - 4px);
    background-color: #f8f9fa;
}

.content-item:only-child {
    min-width: 100%;
    max-width: 100%;
}

.sentence-item {
    width: 100%;

}
    </style>
    
    <body>
        <div class="container">
            <div id="inputPanel" class="panel">
                <h2>文本内容</h2>
                <textarea id="inputText" placeholder="提取图片中的英中文内容，一行一组，英语和中文中间用空格分割，句子不要换行"></textarea>
                
                <div class="button-group">
                    <button id="importBtn" class="small-btn">导入</button>
                    <div id="actionButtons" class="button-row hidden">
                        <button id="toggleSelectAllBtn" class="small-btn">取消全选</button>
                        <button id="invertSelectionBtn" class="small-btn">反选</button>
                        <button id="clearBtn" class="small-btn">清空</button>
                    </div>
                    <div id="statusInfo" class="status-info hidden"></div>
                    <button id="startBtn" class="btn-primary hidden">开始朗读</button>
                </div>
                
                <div id="contentList" class="content-list">
                    <div id="contentGrid" class="content-grid"></div>
                </div>
            </div>
    
            <div id="dictationPanel" class="panel hidden">
                <div class="progress">
                    <span id="progressText">0/0</span>
                </div>
                
                <div class="language-modes">
                    <button id="enToCnModeBtn" class="language-btn active">英→中</button>
                    <button id="cnToEnModeBtn" class="language-btn">中→英</button>
                </div>
                
                <div class="language-modes-row2">
                    <button id="chineseModeBtn" class="language-btn">仅中文</button>
                    <button id="englishModeBtn" class="language-btn">仅英文</button>
                    <button id="toggleChineseBtn" class="language-btn">显示中文</button>
                </div>
                
                <div class="dictation-content">
                    <div id="dictationEnglish" class="dictation-english"></div>
                    <div id="dictationChinese" class="dictation-chinese"></div>
                </div>
                
                <div class="dictation-controls">
                    <button id="prevBtn" class="dictation-btn prev-btn">上一个</button>
                    <button id="nextBtn" class="dictation-btn next-btn">下一个</button>
                    <button id="readBtn" class="dictation-btn">朗读</button>
                    <button id="exitBtn" class="dictation-btn">退出</button>
                </div>
            </div>
        </div>
    
        <script>
            document.addEventListener('DOMContentLoaded', function() {
    // DOM元素
    const elements = {
        inputPanel: document.getElementById('inputPanel'),
        dictationPanel: document.getElementById('dictationPanel'),
        inputText: document.getElementById('inputText'),
        importBtn: document.getElementById('importBtn'),
        startBtn: document.getElementById('startBtn'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        readBtn: document.getElementById('readBtn'),
        exitBtn: document.getElementById('exitBtn'),
        progressText: document.getElementById('progressText'),
        contentList: document.getElementById('contentList'),
        contentGrid: document.getElementById('contentGrid'),
        chineseModeBtn: document.getElementById('chineseModeBtn'),
        englishModeBtn: document.getElementById('englishModeBtn'),
        enToCnModeBtn: document.getElementById('enToCnModeBtn'),
        cnToEnModeBtn: document.getElementById('cnToEnModeBtn'),
        toggleSelectAllBtn: document.getElementById('toggleSelectAllBtn'),
        invertSelectionBtn: document.getElementById('invertSelectionBtn'),
        clearBtn: document.getElementById('clearBtn'),
        actionButtons: document.getElementById('actionButtons'),
        statusInfo: document.getElementById('statusInfo'),
        dictationEnglish: document.getElementById('dictationEnglish'),
        dictationChinese: document.getElementById('dictationChinese'),
        toggleChineseBtn: document.getElementById('toggleChineseBtn')
    };

    // 语音合成
    const synth = window.speechSynthesis;
    let voices = [];
    let currentLineIndex = 0;
    let lines = [];
    let isReading = false;
    let readingMode = 'both';
    let languageOrder = 'english-first'; // 默认英→中
    let currentUtterance = null;
    let displayMode = 'word'; // 默认单词模式
    let showChinese = true; // 默认显示中文
    let isEditing = false;
    
    // 交互状态
    let selectedRows = []; // 存储被选中的行索引
    
    // 初始化语音
    function initVoices() {
        voices = synth.getVoices();
        if (voices.length === 0) {
            setTimeout(initVoices, 100);
        }
    }
    initVoices();
    synth.onvoiceschanged = initVoices;
    
    // 清空内容
    elements.clearBtn.addEventListener('click', function() {
        elements.inputText.value = '';
        lines = [];
        selectedRows = [];
        elements.contentGrid.innerHTML = '';
        elements.startBtn.classList.add('hidden');
        elements.actionButtons.classList.add('hidden');
        elements.statusInfo.classList.add('hidden');
        // 导入按钮保持可见（不再隐藏）
    });

// 修改后的代码
elements.importBtn.addEventListener('click', function() {
    const text = elements.inputText.value.trim();
    if (!text) {
        alert('请输入文本内容');
        return;
    }
    
    const rawLines = text.split('\n').filter(line => line.trim() !== '');
    lines = [];
    
    rawLines.forEach(line => {
        line = line.trim();
        let english = '';
        let chinese = '';
        
        // 改进的分割逻辑
        let splitPos = -1;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            // 如果遇到中文字符或数字开头的中文部分
            if (isChineseChar(char) || (isChineseNumber(char) && i > 0 && !isEnglishChar(line[i-1]))) {
                splitPos = i;
                break;
            }
        }
        
        if (splitPos > 0) {
            english = line.substring(0, splitPos).trim();
            chinese = line.substring(splitPos).trim();
        } else if (splitPos === 0) {
            // 整行都是中文
            chinese = line;
        } else {
            // 整行都是英文
            english = line;
        }
        
        lines.push({
            english: english,
            chinese: chinese
        });
    });
    
    // 更新UI
    selectedRows = Array.from({ length: lines.length }, (_, i) => i);
    elements.actionButtons.classList.remove('hidden');
    elements.statusInfo.classList.remove('hidden');
    elements.startBtn.classList.remove('hidden');
    updateStatusInfo();
    renderContentGrid();
    
    // 导入成功反馈
    this.textContent = '导入成功';
    this.classList.add('btn-success');
    setTimeout(() => {
        this.textContent = '导入';
        this.classList.remove('btn-success');
    }, 2000);
});


// 判断是否是英文字符（包括连字符）
function isEnglishChar(char) {
    return /[a-zA-Z\-]/.test(char);
}

// 新增判断中文数字的函数
function isChineseNumber(char) {
    return /[一二三四五六七八九十百千万亿]/.test(char);
}


// 判断是否是英文标点/符号
function isEnglishPunctuation(char) {
    return /[,.?!;:'"@#$%^&*()]/.test(char);
}

// 判断是否是中文字符
function isChineseChar(char) {
    return /[\u4e00-\u9fa5]/.test(char);
}

function classifyContent(text) {
    text = text.trim();
    if (!text) return 'word'; // 空文本默认为单词
    
    // 中文句子判断
    if (/[\u4e00-\u9fa5]/.test(text) && /[。！？…]/.test(text)) {
        return 'sentence';
    }
    // 英文句子判断
    else if (/^[A-Z].*[.!?]\s*$/.test(text)) {
        return 'sentence';
    }
    // 词组判断（包含空格或连字符）
    else if (/\s|-/.test(text)) {
        return 'phrase';
    }
    // 默认单词
    else {
        return 'word';
    }
}

function detectDisplayMode() {
    if (lines.length === 0) return;

    // 检查是否有句子（开头大写+结尾标点）
    const hasSentence = lines.some(line => {
        const text = line.english.trim();
        return /^[A-Z].*[.!?]\s*$/.test(text);
    });

    // 如果有句子，使用 sentence-mode（每行1个）
    // 否则使用 word-phrase-mode（每行2个）
    displayMode = hasSentence ? 'sentence' : 'word-phrase';
}

    // 更新状态信息
    function updateStatusInfo() {
        elements.statusInfo.textContent = `已导入 ${lines.length} 条，选中 ${selectedRows.length} 条`;
    }

    function renderContentGrid() {
    // 清空容器
    elements.contentGrid.innerHTML = '';
    
    // 创建三个分区
    const sections = {
        word: createSection('单词'),
        phrase: createSection('词组'),
        sentence: createSection('句子')
    };
    
    // 分类内容并统计是否有内容
    const hasContent = {
        word: false,
        phrase: false,
        sentence: false
    };
    
    // 统计各类别的总数和选中数
    const counts = {
        word: { total: 0, selected: 0 },
        phrase: { total: 0, selected: 0 },
        sentence: { total: 0, selected: 0 }
    };
    
    lines.forEach((line, rowIndex) => {
        // 使用统一的classifyContent函数
        const type = classifyContent(line.english);
        hasContent[type] = true;
        counts[type].total++;
        
        if (isRowSelected(rowIndex)) {
            counts[type].selected++;
        }
        
        const item = createContentItem(line, rowIndex, type);
        sections[type].grid.appendChild(item);
    });
    
    // 更新分区标题，添加计数
    if (hasContent.word) {
        sections.word.title.innerHTML = `单词 <span class="section-count">${counts.word.selected}/${counts.word.total}</span>`;
        elements.contentGrid.appendChild(sections.word.container);
    }
    if (hasContent.phrase) {
        sections.phrase.title.innerHTML = `词组 <span class="section-count">${counts.phrase.selected}/${counts.phrase.total}</span>`;
        elements.contentGrid.appendChild(sections.phrase.container);
    }
    if (hasContent.sentence) {
        sections.sentence.title.innerHTML = `句子 <span class="section-count">${counts.sentence.selected}/${counts.sentence.total}</span>`;
        elements.contentGrid.appendChild(sections.sentence.container);
    }
    
    setupItemInteractions();
    updateStatusInfo();
}

// 创建分区函数
function createSection(title) {
    const container = document.createElement('div');
    container.className = 'content-section';
    
    const titleEl = document.createElement('h3');
    titleEl.className = 'section-title';
    titleEl.textContent = title;
    
    const grid = document.createElement('div');
    grid.className = 'content-grid';
    grid.style.display = 'flex';
    grid.style.flexWrap = 'wrap';
    grid.style.gap = '8px';
    
    container.appendChild(titleEl);
    container.appendChild(grid);
    
    return { container, grid, title: titleEl };
}

function createContentItem(line, rowIndex, type) {
    const item = document.createElement('div');
    item.className = `content-item ${type}-item`;
    item.dataset.rowIndex = rowIndex;
    item.dataset.type = type;
    
    if (isRowSelected(rowIndex)) {
        item.classList.add('selected');
    }
    
    item.innerHTML = `
        <div class="english-container">${line.english}</div>
        ${line.chinese ? `<div class="chinese-container">${line.chinese}</div>` : ''}
    `;
    
    return item;
}
    
    // 检查行是否被选中
    function isRowSelected(rowIndex) {
        return selectedRows.includes(rowIndex);
    }
    
    // 设置项目交互
    function setupItemInteractions() {
    let touchStartTime = 0;
    let touchStartY = 0;
    let activeElement = null;
    const MAX_TAP_DURATION = 200; // 毫秒
    const MAX_TAP_DISTANCE = 8; // 像素

    document.querySelectorAll('.content-item').forEach(item => {
        // 触摸开始
        item.addEventListener('touchstart', function(e) {
            touchStartTime = Date.now();
            touchStartY = e.touches[0].clientY;
            activeElement = this;
        }, { passive: true });

        // 触摸移动（仅标记不处理）
        item.addEventListener('touchmove', function() {
            activeElement = null; // 标记为滑动操作
        }, { passive: true });

        // 触摸结束
        item.addEventListener('touchend', function(e) {
            if (!activeElement) return;
            
            const touchEndY = e.changedTouches[0].clientY;
            const touchDuration = Date.now() - touchStartTime;
            const distance = Math.abs(touchEndY - touchStartY);
            
            // 判断是否为有效点击
            if (touchDuration <= MAX_TAP_DURATION && distance <= MAX_TAP_DISTANCE) {
                e.preventDefault();
                handleItemSelection(parseInt(this.dataset.rowIndex));
            }
        }, { passive: false });

        // 点击事件（鼠标）
        item.addEventListener('click', function() {
            handleItemSelection(parseInt(this.dataset.rowIndex));
        });
    });
}
    
    // 切换行选择状态
    function handleItemSelection(rowIndex) {
    const isSelected = isRowSelected(rowIndex);
    toggleRowSelection(rowIndex, !isSelected);
}

// 切换行选择状态
function toggleRowSelection(rowIndex, select) {
    if (select) {
        if (!isRowSelected(rowIndex)) {
            selectedRows.push(rowIndex);
        }
    } else {
        selectedRows = selectedRows.filter(index => index !== rowIndex);
    }
    
    // 重新渲染以更新UI
    renderContentGrid();
    updateToggleSelectAllButton();
}
    
    // 反选功能
    elements.invertSelectionBtn.addEventListener('click', invertSelection);
    
    function invertSelection() {
        const allRowIndices = Array.from({ length: lines.length }, (_, i) => i);
        selectedRows = allRowIndices.filter(rowIndex => !selectedRows.includes(rowIndex));
        renderContentGrid();
        updateToggleSelectAllButton();
    }
    
    // 全选/取消全选
    elements.toggleSelectAllBtn.addEventListener('click', function() {
        const allSelected = lines.length > 0 && selectedRows.length === lines.length;
        
        if (allSelected) {
            deselectAll();
            this.textContent = '全选';
        } else {
            selectAll();
            this.textContent = '取消全选';
        }
    });
    
    // 全选所有内容
    function selectAll() {
        selectedRows = Array.from({ length: lines.length }, (_, i) => i);
        renderContentGrid();
        elements.toggleSelectAllBtn.textContent = '取消全选';
    }
    
    // 取消全选
    function deselectAll() {
        selectedRows = [];
        renderContentGrid();
        elements.toggleSelectAllBtn.textContent = '全选';
    }
    
    // 更新全选按钮状态
    function updateToggleSelectAllButton() {
        const allSelected = lines.length > 0 && selectedRows.length === lines.length;
        elements.toggleSelectAllBtn.textContent = allSelected ? '取消全选' : '全选';
    }

    // 开始朗读
    elements.startBtn.addEventListener('click', function() {
        if (lines.length === 0) {
            alert('没有可朗读的内容');
            return;
        }
        
        if (selectedRows.length === 0) {
            alert('请选择要朗读的内容');
            return;
        }
        
        currentLineIndex = 0;
        elements.inputPanel.classList.add('hidden');
        elements.dictationPanel.classList.remove('hidden');
        updateProgress();
        updateDictationContent();
        readCurrentItem();
    });

    // 更新进度
    function updateProgress() {
        elements.progressText.textContent = `${currentLineIndex + 1}/${selectedRows.length}`;
    }
    
    // 更新朗读内容显示
    function updateDictationContent() {
        if (currentLineIndex >= selectedRows.length) return;
        
        const rowIndex = selectedRows[currentLineIndex];
        const line = lines[rowIndex];
        
        elements.dictationChinese.textContent = line.chinese;
        
        // 根据显示设置更新中文显示状态
        if (showChinese) {
            elements.dictationChinese.classList.remove('hidden');
        } else {
            elements.dictationChinese.classList.add('hidden');
        }
    }

    // 朗读当前项
    function readCurrentItem() {
        stopReading();
        
        if (currentLineIndex >= selectedRows.length) {
            currentLineIndex = selectedRows.length - 1;
            return;
        }
        
        const rowIndex = selectedRows[currentLineIndex];
        const line = lines[rowIndex];
        if (!line) return;
        
        isReading = true;
        readContentWithSettings(line);
    }

    // 根据设置朗读内容
    function readContentWithSettings(line) {
        if (readingMode === 'chinese') {
            if (line.chinese) readText(line.chinese, 'zh');
        } else if (readingMode === 'english') {
            if (line.english) readText(line.english, 'en');
        } else {
            if (languageOrder === 'english-first') {
                // 英→中模式
                if (line.english && line.chinese) {
                    readText(line.english, 'en', () => {
                        setTimeout(() => readText(line.chinese, 'zh'), 500);
                    });
                } else if (line.english) {
                    readText(line.english, 'en');
                } else if (line.chinese) {
                    readText(line.chinese, 'zh');
                }
            } else {
                // 中→英模式
                if (line.chinese && line.english) {
                    readText(line.chinese, 'zh', () => {
                        setTimeout(() => readText(line.english, 'en'), 500);
                    });
                } else if (line.chinese) {
                    readText(line.chinese, 'zh');
                } else if (line.english) {
                    readText(line.english, 'en');
                }
            }
        }
    }
    
    // 朗读文本
    function readText(text, lang, onEnd) {
        stopReading();
        
        currentUtterance = new SpeechSynthesisUtterance(text);
        currentUtterance.rate = lang === 'zh' ? 0.9 : 1.0;
        
        const voice = voices.find(v => v.lang.includes(lang === 'zh' ? 'zh' : 'en'));
        if (voice) currentUtterance.voice = voice;
        
        if (onEnd) {
            currentUtterance.onend = onEnd;
        }
        
        synth.speak(currentUtterance);
    }

    // 停止朗读
    function stopReading() {
        if (currentUtterance) {
            synth.cancel();
            currentUtterance = null;
        }
    }

    // 上一个
    elements.prevBtn.addEventListener('click', function() {
        if (currentLineIndex > 0) {
            currentLineIndex--;
            updateProgress();
            updateDictationContent();
            readCurrentItem();
        }
    });

    // 下一个
    elements.nextBtn.addEventListener('click', function() {
        currentLineIndex++;
        if (currentLineIndex >= selectedRows.length) {
            alert('朗读已完成！');
            currentLineIndex = selectedRows.length - 1;
            updateProgress();
            return;
        }
        updateProgress();
        updateDictationContent();
        readCurrentItem();
    });

    // 朗读当前项
    elements.readBtn.addEventListener('click', readCurrentItem);

    // 退出
    elements.exitBtn.addEventListener('click', exitDictation);

    // 退出朗读模式
    function exitDictation() {
        if (confirm('确定要退出听写模式吗？')) {
            stopReading();
            elements.inputPanel.classList.remove('hidden');
            elements.dictationPanel.classList.add('hidden');
            isReading = false;
        }
    }

    // 语言模式切换
    elements.chineseModeBtn.addEventListener('click', () => setReadingMode('chinese'));
    elements.englishModeBtn.addEventListener('click', () => setReadingMode('english'));
    elements.enToCnModeBtn.addEventListener('click', () => {
        setReadingMode('both');
        languageOrder = 'english-first';
        updateLanguageButtons();
        if (isReading) {
            updateDictationContent();
            readCurrentItem();
        }
    });
    elements.cnToEnModeBtn.addEventListener('click', () => {
        setReadingMode('both');
        languageOrder = 'chinese-first';
        updateLanguageButtons();
        if (isReading) {
            updateDictationContent();
            readCurrentItem();
        }
    });
    
    // 切换中文显示
    elements.toggleChineseBtn.addEventListener('click', toggleChineseDisplay);
    
    function toggleChineseDisplay() {
        showChinese = !showChinese;
        elements.toggleChineseBtn.textContent = showChinese ? '隐藏中文' : '显示中文';
        updateDictationContent();
    }

    function setReadingMode(mode) {
        readingMode = mode;
        updateLanguageButtons();
        if (isReading) {
            updateDictationContent();
            readCurrentItem();
        }
    }

    // 更新语言按钮状态
    function updateLanguageButtons() {
        elements.chineseModeBtn.classList.remove('active');
        elements.englishModeBtn.classList.remove('active');
        elements.enToCnModeBtn.classList.remove('active');
        elements.cnToEnModeBtn.classList.remove('active');
        
        if (readingMode === 'chinese') {
            elements.chineseModeBtn.classList.add('active');
        } else if (readingMode === 'english') {
            elements.englishModeBtn.classList.add('active');
        } else {
            if (languageOrder === 'english-first') {
                elements.enToCnModeBtn.classList.add('active');
            } else {
                elements.cnToEnModeBtn.classList.add('active');
            }
        }
    }
});
        </script>
    </body>
</html>